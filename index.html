<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNCUT — AI Draping Guide</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #FAF8F5;
  --card: #ffffff;
  --accent: #B8856C;
  --accent-soft: rgba(184,133,108,0.12);
  --accent-ghost: rgba(184,133,108,0.06);
  --sage: #7B9E7B;
  --sage-soft: rgba(123,158,123,0.1);
  --text: #1a1a1a;
  --text-mid: #555555;
  --text-light: #999999;
  --border: #E8E3DD;
  --shadow: 0 2px 16px rgba(0,0,0,0.05);
  --font-display: 'Cormorant Garamond', 'Georgia', serif;
  --font-body: -apple-system, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
  --radius: 14px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); font-family: var(--font-body); color: var(--text); }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

@keyframes formDraw { from { stroke-dashoffset: 1200; } to { stroke-dashoffset: 0; } }
@keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes dotPulse { 0%,100% { opacity: .3; } 50% { opacity: 1; } }

/* SCREENS */
.screen { display: none; }
.screen.active { display: block; }

/* UPLOAD */
.upload-screen {
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 40px;
}
.brand { text-align: center; margin-bottom: 48px; animation: fadeUp 0.6s ease; }
.brand h1 { font-family: 'Oswald', sans-serif; font-size: 64px; font-weight: 400; letter-spacing: 12px; text-transform: uppercase; }
.brand .sub { font-family: var(--font-display); font-size: 16px; color: var(--text-light); font-style: italic; letter-spacing: 3px; }
.brand .line { width: 40px; height: 1.5px; background: var(--accent); margin: 20px auto 0; }
.brand .desc { margin-top: 20px; font-size: 15px; color: var(--text-mid); max-width: 420px; line-height: 1.7; }

.drop-zone {
  width: 100%; max-width: 480px; min-height: 280px;
  border: 2px dashed var(--border); border-radius: 16px; padding: 40px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.3s ease; animation: fadeUp 0.6s ease 0.15s both;
}
.drop-zone.drag-over { border-color: var(--accent); background: var(--accent-ghost); }
.drop-zone.has-preview { padding: 12px; min-height: auto; }
.drop-zone .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.4; }
.drop-zone .label { font-size: 15px; color: var(--text-mid); }
.drop-zone .sublabel { font-size: 13px; color: var(--text-light); margin-top: 6px; }
.drop-zone img { width: 100%; max-height: 400px; object-fit: contain; border-radius: 10px; }

.actions { margin-top: 24px; display: flex; gap: 14px; animation: fadeUp 0.3s ease; }
.btn { padding: 12px 28px; border-radius: 10px; font-size: 14px; cursor: pointer; font-family: var(--font-body); transition: all 0.2s; }
.btn-secondary { border: 1px solid var(--border); background: transparent; color: var(--text-mid); }
.btn-primary { border: none; background: var(--accent); color: #fff; font-weight: 600; padding: 12px 36px; }
.btn-primary:disabled { background: var(--text-light); cursor: wait; }
.footer-note { margin-top: 60px; font-size: 12px; color: var(--text-light); animation: fadeUp 0.6s ease 0.3s both; }

/* LOADING */
.loading-screen {
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
}
.loading-screen .form-wrap { width: 160px; margin-bottom: 32px; animation: fadeIn 0.5s ease; }
.loading-screen .form-wrap svg { width: 100%; }
.loading-screen .msg { font-size: 18px; font-family: var(--font-display); letter-spacing: 1px; }
.loading-screen .msg span:nth-child(1) { animation: dotPulse 1.2s infinite 0s; }
.loading-screen .msg span:nth-child(2) { animation: dotPulse 1.2s infinite 0.2s; }
.loading-screen .msg span:nth-child(3) { animation: dotPulse 1.2s infinite 0.4s; }
.loading-screen .submsg { font-size: 13px; color: var(--text-light); margin-top: 10px; }

/* TUTORIAL */
.topbar {
  position: sticky; top: 0; z-index: 50;
  background: rgba(250,248,245,0.92); backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border); padding: 12px 32px;
  display: flex; align-items: center; gap: 16px;
}
.topbar h2 { font-family: var(--font-display); font-size: 22px; font-weight: 600; flex: 1; }
.topbar .back-btn {
  background: none; border: 1px solid var(--border); border-radius: 8px;
  padding: 6px 14px; cursor: pointer; font-size: 13px; color: var(--text-mid); font-family: var(--font-body);
}
.difficulty { display: flex; gap: 5px; align-items: center; }
.difficulty .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--border); }
.difficulty .dot.filled { background: var(--accent); }
.difficulty .label { margin-left: 6px; font-size: 13px; color: var(--text-light); }

.tutorial-content { max-width: 800px; margin: 0 auto; }
.right-panel { padding: 28px 32px 60px; }

.overview-card {
  background: var(--card); border-radius: var(--radius); padding: 28px;
  margin-bottom: 24px; box-shadow: var(--shadow); animation: fadeUp 0.5s ease;
}
.overview-card h3 { font-family: var(--font-display); font-size: 24px; margin-bottom: 10px; }
.overview-card .analysis { line-height: 1.8; color: var(--text-mid); font-size: 14.5px; }
.overview-meta { display: flex; gap: 20px; margin-top: 16px; flex-wrap: wrap; }
.overview-meta .meta-label { font-size: 11px; color: var(--text-light); }
.overview-meta .meta-value { font-size: 14px; font-weight: 600; margin-top: 4px; }

.list-row { display: flex; gap: 18px; margin-bottom: 28px; flex-wrap: wrap; }
.list-card {
  flex: 1; min-width: 260px; background: var(--card);
  border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow);
}
.list-card h4 { font-size: 15px; font-weight: 600; margin-bottom: 14px; }
.list-item { padding: 10px 0; border-bottom: 1px solid var(--border); }
.list-item:last-child { border-bottom: none; }
.list-item .name { font-size: 14px; font-weight: 600; }
.list-item .spec { font-size: 12.5px; color: var(--text-mid); margin-top: 3px; }
.list-item .qty { font-size: 12px; color: var(--accent); margin-top: 2px; }

.section-divider { display: flex; align-items: center; gap: 16px; margin: 32px 0 28px; }
.section-divider .line { flex: 1; height: 1px; background: var(--border); }
.section-divider .title { font-family: var(--font-display); font-size: 18px; color: var(--accent); font-weight: 600; }

.step-card {
  background: var(--card); border-radius: var(--radius); padding: 28px 28px 24px;
  margin-bottom: 18px; border-left: 3px solid var(--accent); box-shadow: var(--shadow);
}
.step-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
.step-num {
  width: 42px; height: 42px; border-radius: 50%;
  background: var(--accent-soft); color: var(--accent);
  display: flex; align-items: center; justify-content: center;
  font-family: var(--font-display); font-size: 20px; font-weight: 700; flex-shrink: 0;
}
.step-icon { font-size: 22px; }
.step-title-wrap { flex: 1; }
.step-title-wrap h3 { font-size: 17px; font-weight: 600; }
.step-title-wrap .technique { font-size: 12px; color: var(--accent); }
.area-tag {
  font-size: 11px; color: var(--accent); background: var(--accent-ghost);
  padding: 4px 12px; border-radius: 20px; font-weight: 500; white-space: nowrap;
}
.step-desc { line-height: 1.85; color: var(--text-mid); font-size: 14.5px; margin-bottom: 20px; }
.tips-box {
  margin-top: 16px; background: var(--sage-soft); border-radius: 10px;
  padding: 14px 18px; border-left: 3px solid var(--sage);
}
.tips-box .tips-label { font-size: 12px; font-weight: 600; color: var(--sage); margin-bottom: 6px; }
.tips-box p { font-size: 13.5px; line-height: 1.7; color: var(--text-mid); }

.trouble-section { border-top: 1px solid var(--border); padding-top: 14px; margin-top: 8px; }
.trouble-toggle {
  background: none; border: none; cursor: pointer; display: flex;
  align-items: center; gap: 8px; font-size: 13px; color: var(--text-light); padding: 0;
  font-family: var(--font-body);
}
.trouble-toggle .arrow { display: inline-block; transition: transform 0.2s; }
.trouble-toggle .arrow.open { transform: rotate(90deg); }
.trouble-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; }
.trouble-content.open { max-height: 500px; padding-top: 12px; }
.trouble-item { margin-bottom: 10px; padding-left: 8px; }
.trouble-item .q { font-size: 13px; font-weight: 600; color: #c0392b; margin-bottom: 3px; }
.trouble-item .a { font-size: 13px; color: var(--text-mid); padding-left: 22px; }

.step-progress { text-align: right; font-size: 11px; color: var(--text-light); margin-top: 12px; }
.completion { text-align: center; padding: 48px 24px; }
.completion .emoji { font-size: 48px; margin-bottom: 16px; }
.completion h3 { font-family: var(--font-display); font-size: 24px; margin-bottom: 8px; }
.completion p { color: var(--text-mid); font-size: 14px; line-height: 1.7; max-width: 400px; margin: 0 auto; }
.completion .btn-primary { margin-top: 24px; }

.error-toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%);
  background: #c0392b; color: #fff; padding: 12px 24px; border-radius: 10px;
  font-size: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100;
  animation: fadeUp 0.3s ease; display: none;
}
.error-toast.visible { display: flex; align-items: center; gap: 12px; }
.error-toast .close-btn {
  background: rgba(255,255,255,0.2); border: none; color: #fff;
  padding: 2px 10px; border-radius: 6px; cursor: pointer;
}

/* ====== TOC 悬浮目录 ====== */
.toc-fab {
  position: fixed; bottom: 28px; left: 28px; z-index: 80;
  background: var(--accent); color: #fff; border: none; border-radius: 12px;
  padding: 10px 18px; font-size: 14px; font-family: var(--font-body);
  cursor: pointer; box-shadow: 0 4px 20px rgba(184,133,108,0.35);
  transition: all 0.25s ease; display: none;
}
.toc-fab:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(184,133,108,0.45); }
.toc-panel {
  position: fixed; bottom: 78px; left: 28px; z-index: 80;
  width: 260px; max-height: 420px; overflow-y: auto;
  background: var(--card); border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border: 1px solid var(--border); padding: 12px 0;
  transform: translateY(12px); opacity: 0; pointer-events: none;
  transition: all 0.25s ease; display: none;
}
.toc-panel.visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
.toc-panel .toc-title {
  padding: 4px 18px 10px; font-size: 13px; font-weight: 600;
  color: var(--text-light); border-bottom: 1px solid var(--border);
}
.toc-panel .toc-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 18px; cursor: pointer; font-size: 13.5px;
  color: var(--text-mid); transition: all 0.15s; border-left: 3px solid transparent;
}
.toc-panel .toc-item:hover { background: var(--accent-ghost); color: var(--text); }
.toc-panel .toc-item.active { background: var(--accent-soft); color: var(--accent); border-left-color: var(--accent); font-weight: 600; }
.toc-panel .toc-item .toc-num {
  width: 24px; height: 24px; border-radius: 50%; background: var(--accent-ghost);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 600; color: var(--accent); flex-shrink: 0;
}
.toc-panel .toc-item.active .toc-num { background: var(--accent); color: #fff; }

/* ====== 设计图预览 + Lightbox ====== */
.design-thumb {
  position: fixed; top: 68px; right: 24px; z-index: 70;
  width: 56px; height: 56px; border-radius: 10px; overflow: hidden;
  border: 2px solid var(--border); cursor: pointer;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08); transition: all 0.25s ease;
  display: none; background: var(--card);
}
.design-thumb:hover { transform: scale(1.08); box-shadow: 0 4px 20px rgba(0,0,0,0.14); border-color: var(--accent); }
.design-thumb img { width: 100%; height: 100%; object-fit: cover; }
.lightbox-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 200; background: rgba(0,0,0,0.82); backdrop-filter: blur(6px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
}
.lightbox-overlay.visible { opacity: 1; pointer-events: auto; }
.lightbox-overlay img {
  max-width: 88vw; max-height: 88vh; object-fit: contain;
  border-radius: 12px; box-shadow: 0 8px 48px rgba(0,0,0,0.4);
}
.lightbox-close {
  position: absolute; top: 20px; right: 24px;
  background: rgba(255,255,255,0.15); border: none; color: #fff;
  font-size: 28px; width: 44px; height: 44px; border-radius: 50%;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.lightbox-close:hover { background: rgba(255,255,255,0.3); }

/* ====== 人台 SVG 示意图 ====== */
.step-body { display: flex; gap: 18px; align-items: flex-start; }
.step-text { flex: 1; min-width: 0; }
.step-mannequin { width: 72px; flex-shrink: 0; }
.step-mannequin svg { width: 100%; height: auto; }
@media (max-width: 580px) {
  .step-body { flex-direction: column-reverse; align-items: center; }
  .step-mannequin { width: 60px; }
  .toc-fab { bottom: 16px; left: 16px; padding: 8px 14px; font-size: 13px; }
  .toc-panel { bottom: 64px; left: 16px; width: 240px; max-height: 340px; }
  .design-thumb { top: 62px; right: 12px; width: 44px; height: 44px; }
}
</style>
</head>
<body>

<!-- UPLOAD -->
<div id="upload-screen" class="screen active">
  <div class="upload-screen">
    <div class="brand">
      <h1>UNCUT</h1>
      <p class="sub">AI-Powered Draping Guide</p>
      <div class="line"></div>
      <p class="desc">上传参考图片，AI 将为你生成详细的分步立裁操作教程</p>
    </div>
    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept="image/*" hidden>
      <div id="drop-placeholder">
        <div class="icon">&#9986;</div>
        <p class="label">拖拽参考图片到这里</p>
        <p class="sublabel">或点击选择文件 · 支持 JPG / PNG</p>
      </div>
      <img id="preview-img" style="display:none;" alt="preview">
    </div>
    <div class="actions" id="upload-actions" style="display:none;">
      <button class="btn btn-secondary" id="btn-reselect">重新选择</button>
      <button class="btn btn-primary" id="btn-analyze">生成立裁教程 &rarr;</button>
    </div>
    <p class="footer-note">Powered by Claude</p>
  </div>
</div>

<!-- LOADING -->
<div id="loading-screen" class="screen">
  <div class="loading-screen">
    <div class="form-wrap">
      <svg viewBox="0 0 160 300">
        <path d="M80,15 C80,15 93,18 93,36 L130,46 C133,50 128,58 124,72 C120,86 123,94 121,110 C119,126 109,138 108,145 C107,153 109,163 114,178 C120,193 122,204 119,218 L116,235 L44,235 C41,218 40,204 46,178 C51,163 53,153 52,145 C51,138 41,126 39,110 C37,94 40,86 36,72 C32,58 27,50 30,46 L67,36 C67,18 80,15 80,15 Z"
          fill="none" stroke="#1a1a1a" stroke-width="1.5"
          style="stroke-dasharray:1200;animation:formDraw 2.5s ease forwards"/>
        <line x1="80" y1="235" x2="80" y2="272" stroke="#1a1a1a" stroke-width="1.5"/>
        <ellipse cx="80" cy="275" rx="28" ry="6" fill="none" stroke="#1a1a1a" stroke-width="1.5"/>
      </svg>
    </div>
    <p class="msg">正在分析你的设计<span>.</span><span>.</span><span>.</span></p>
    <p class="submsg">AI 正在识别设计结构并生成立裁教程</p>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tutorial-screen" class="screen">
  <div class="topbar">
    <button class="back-btn" id="btn-back">&larr; 返回</button>
    <h2 id="design-name"></h2>
    <div class="difficulty" id="difficulty-dots"></div>
  </div>
  <div class="tutorial-content">
    <div class="right-panel" id="right-panel"></div>
  </div>
  <!-- TOC 悬浮目录 -->
  <button class="toc-fab" id="toc-fab">&#9776; 步骤目录</button>
  <div class="toc-panel" id="toc-panel">
    <div class="toc-title">&#128209; 步骤目录</div>
    <div id="toc-list"></div>
  </div>
  <!-- 设计图缩略图 -->
  <div class="design-thumb" id="design-thumb">
    <img id="design-thumb-img" alt="设计图" />
  </div>
  <!-- Lightbox -->
  <div class="lightbox-overlay" id="lightbox-overlay">
    <button class="lightbox-close" id="lightbox-close">&times;</button>
    <img id="lightbox-img" alt="设计图大图" />
  </div>
</div>

<!-- ERROR -->
<div class="error-toast" id="error-toast">
  <span id="error-msg"></span>
  <button class="close-btn" id="error-close">&times;</button>
</div>

<script>
/* ====== CONSTANTS ====== */
var ICONS = { pin:"\uD83D\uDCCC", scissors:"\u2702\uFE0F", pencil:"\u270F\uFE0F", ruler:"\uD83D\uDCD0", hand:"\u270B", fold:"\uD83D\uDD04", iron:"\uD83D\uDD25", measure:"\uD83D\uDCCF" };
var AREA_LABELS = { neck:"\u9886\u53E3", shoulder:"\u80A9\u90E8", chest:"\u80F8\u90E8", waist:"\u8170\u90E8", hip:"\u81C0\u90E8", hem:"\u4E0B\u6446", side:"\u4FA7\u7F1D", back:"\u540E\u80CC", full:"\u6574\u4F53" };
var DIF_LABELS = ["","入门","初级","中等","中高","高级"];

/* ====== MANNEQUIN SVG 数据 ====== */
var MANNEQUIN_PATH = 'M80,15 C80,15 93,18 93,36 L130,46 C133,50 128,58 124,72 C120,86 123,94 121,110 C119,126 109,138 108,145 C107,153 109,163 114,178 C120,193 122,204 119,218 L116,235 L44,235 C41,218 40,204 46,178 C51,163 53,153 52,145 C51,138 41,126 39,110 C37,94 40,86 36,72 C32,58 27,50 30,46 L67,36 C67,18 80,15 80,15 Z';
var AREA_REGIONS = {
  neck:      { path:'M67,30 C67,30 72,25 80,25 C88,25 93,30 93,30 L93,42 L67,42 Z', color:'#E8856C' },
  shoulder:  { path:'M30,46 L67,36 L67,50 L30,54 Z M93,36 L130,46 L130,54 L93,50 Z', color:'#D4A574' },
  chest:     { path:'M36,54 L124,54 L124,90 L36,90 Z', color:'#C9927A' },
  waist:     { path:'M39,100 L121,100 L121,128 L39,128 Z', color:'#B8856C' },
  hip:       { path:'M46,155 L114,155 L119,200 L41,200 Z', color:'#D4A574' },
  hem:       { path:'M44,215 L116,215 L116,235 L44,235 Z', color:'#C9927A' },
  side:      { path:'M30,46 L40,46 L39,180 L41,235 L44,235 L46,180 L36,72 L30,46 Z M130,46 L120,46 L121,180 L119,235 L116,235 L114,180 L124,72 L130,46 Z', color:'#E8A080' },
  back:      { path:'M52,60 L108,60 L108,145 L52,145 Z', color:'#D4B8A0' },
  full:      { path:'M30,46 L67,36 C67,18 80,15 80,15 C80,15 93,18 93,36 L130,46 C133,50 128,58 124,72 C120,86 123,94 121,110 C119,126 109,138 108,145 C107,153 109,163 114,178 C120,193 122,204 119,218 L116,235 L44,235 C41,218 40,204 46,178 C51,163 53,153 52,145 C51,138 41,126 39,110 C37,94 40,86 36,72 C32,58 27,50 30,46 Z', color:'#E8D0C0' }
};

/* ====== STATE ====== */
var fileBase64 = null;
var fileMediaType = null;
var tutorialData = null;
var uploadedImageUrl = null;
var tocObserver = null;

/* ====== HELPERS ====== */
function $(id) { return document.getElementById(id); }
var screens = { upload: $('upload-screen'), loading: $('loading-screen'), tutorial: $('tutorial-screen') };

function showScreen(name) {
  for (var k in screens) screens[k].classList.remove('active');
  screens[name].classList.add('active');
}

function showError(msg) {
  $('error-msg').textContent = msg;
  $('error-toast').classList.add('visible');
}
$('error-close').addEventListener('click', function() { $('error-toast').classList.remove('visible'); });

/* ====== SAFE REPEAT (核心修复) ====== */
function safeRepeat(str, n) {
  var count = parseInt(n, 10);
  if (!isFinite(count) || count < 0) count = 0;
  if (count > 100) count = 100;
  return str.repeat(count);
}

/* ====== IMAGE COMPRESS ====== */
function compressImage(file) {
  return new Promise(function(resolve) {
    var img = new Image();
    img.onload = function() {
      var w = img.width, h = img.height;
      var maxSize = 800;
      if (w > maxSize || h > maxSize) {
        var ratio = Math.min(maxSize / w, maxSize / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
      }
      var canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      resolve({ base64: dataUrl.split(',')[1], mediaType: 'image/jpeg' });
    };
    img.src = URL.createObjectURL(file);
  });
}

/* ====== UPLOAD ====== */
var dropZone = $('drop-zone');
var fileInput = $('file-input');
var previewImg = $('preview-img');
var placeholder = $('drop-placeholder');

function processFile(file) {
  if (!file || !file.type.startsWith('image/')) return;
  // 释放旧的 blob URL
  if (uploadedImageUrl) URL.revokeObjectURL(uploadedImageUrl);
  uploadedImageUrl = URL.createObjectURL(file);
  previewImg.src = uploadedImageUrl;
  previewImg.style.display = 'block';
  placeholder.style.display = 'none';
  dropZone.classList.add('has-preview');
  $('upload-actions').style.display = 'flex';
  compressImage(file).then(function(result) {
    fileBase64 = result.base64;
    fileMediaType = result.mediaType;
  });
}

function resetUpload() {
  previewImg.style.display = 'none';
  previewImg.src = '';
  placeholder.style.display = 'flex';
  dropZone.classList.remove('has-preview');
  $('upload-actions').style.display = 'none';
  fileBase64 = null;
  fileMediaType = null;
  fileInput.value = '';
}

dropZone.addEventListener('click', function() { fileInput.click(); });
dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('drag-over'); });
dropZone.addEventListener('drop', function(e) { e.preventDefault(); dropZone.classList.remove('drag-over'); processFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', function(e) { processFile(e.target.files[0]); });
$('btn-reselect').addEventListener('click', resetUpload);

/* ====== ANALYZE ====== */
async function analyze() {
  if (!fileBase64) return;
  $('btn-analyze').disabled = true;
  $('btn-analyze').textContent = '分析中...';
  showScreen('loading');

  try {
    var controller = new AbortController();
    var timeout = setTimeout(function() { controller.abort(); }, 150000);

    var resp;
    try {
      resp = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        signal: controller.signal,
        body: JSON.stringify({ imageBase64: fileBase64, mediaType: fileMediaType })
      });
    } catch (e) {
      if (e.name === 'AbortError') throw new Error('请求超时（150秒），请稍后重试');
      throw new Error('网络请求失败，请检查网络连接');
    } finally {
      clearTimeout(timeout);
    }

    var rawText = await resp.text();
    var json;
    try { json = JSON.parse(rawText); } catch (e) {
      console.error('Non-JSON response:', rawText.substring(0, 300));
      throw new Error('服务器返回了异常响应，请稍后重试');
    }

    if (!resp.ok) {
      throw new Error(json.error || '请求失败 (' + resp.status + ')');
    }

    if (!json.tutorial) {
      console.error('Missing tutorial:', Object.keys(json));
      throw new Error('服务器返回数据格式异常，请重试');
    }

    tutorialData = json.tutorial;
    renderTutorial();
    showScreen('tutorial');
  } catch (err) {
    console.error('Analyze error:', err);
    showError(err.message || '分析失败，请重试');
    showScreen('upload');
  } finally {
    $('btn-analyze').disabled = false;
    $('btn-analyze').textContent = '生成立裁教程 \u2192';
  }
}
$('btn-analyze').addEventListener('click', analyze);

/* ====== BACK ====== */
$('btn-back').addEventListener('click', function() {
  tutorialData = null;
  // 清理 TOC observer
  if (tocObserver) { tocObserver.disconnect(); tocObserver = null; }
  // 隐藏浮动元素
  $('toc-fab').style.display = 'none';
  $('toc-panel').style.display = 'none';
  $('toc-panel').classList.remove('visible');
  $('design-thumb').style.display = 'none';
  $('lightbox-overlay').classList.remove('visible');
  // 释放图片内存
  if (uploadedImageUrl) { URL.revokeObjectURL(uploadedImageUrl); uploadedImageUrl = null; }
  $('design-thumb-img').src = '';
  $('lightbox-img').src = '';
  resetUpload();
  showScreen('upload');
});

/* ====== MANNEQUIN SVG BUILDER ====== */
function buildMannequinSVG(area, stepNum) {
  var region = AREA_REGIONS[area] || AREA_REGIONS['full'];
  var svg = '<svg viewBox="0 0 160 260" xmlns="http://www.w3.org/2000/svg">';
  // 高亮区域
  svg += '<path d="' + region.path + '" fill="' + region.color + '" opacity="0.35"/>';
  // 人台轮廓
  svg += '<path d="' + MANNEQUIN_PATH + '" fill="none" stroke="#1a1a1a" stroke-width="1.2"/>';
  // 底座
  svg += '<line x1="80" y1="235" x2="80" y2="252" stroke="#1a1a1a" stroke-width="1.2"/>';
  svg += '<ellipse cx="80" cy="255" rx="24" ry="5" fill="none" stroke="#1a1a1a" stroke-width="1.2"/>';
  // 步骤序号标记
  svg += '<circle cx="130" cy="24" r="14" fill="' + region.color + '" opacity="0.9"/>';
  svg += '<text x="130" y="29" text-anchor="middle" font-size="14" font-weight="700" fill="#fff">' + stepNum + '</text>';
  svg += '</svg>';
  return svg;
}

/* ====== TOC INIT ====== */
function initStepTOC() {
  var tocFab = $('toc-fab');
  var tocPanel = $('toc-panel');
  var tocList = $('toc-list');
  if (!tutorialData || !tutorialData.steps) return;

  var steps = tutorialData.steps;
  // 生成目录列表
  var listHtml = '';
  for (var i = 0; i < steps.length; i++) {
    listHtml += '<div class="toc-item" data-step="' + i + '">';
    listHtml += '<span class="toc-num">' + (i + 1) + '</span>';
    listHtml += '<span>' + (steps[i].title || '步骤 ' + (i + 1)) + '</span>';
    listHtml += '</div>';
  }
  tocList.innerHTML = listHtml;

  // 显示按钮
  tocFab.style.display = 'block';
  tocPanel.style.display = 'block';

  // 切换面板
  tocFab.onclick = function() {
    tocPanel.classList.toggle('visible');
  };

  // 点击面板外关闭
  document.addEventListener('click', function(e) {
    if (!tocPanel.contains(e.target) && e.target !== tocFab) {
      tocPanel.classList.remove('visible');
    }
  });

  // 点击步骤滚动
  tocList.onclick = function(e) {
    var item = e.target.closest('.toc-item');
    if (!item) return;
    var idx = parseInt(item.getAttribute('data-step'), 10);
    var cards = document.querySelectorAll('.step-card');
    if (cards[idx]) {
      cards[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
      tocPanel.classList.remove('visible');
    }
  };

  // IntersectionObserver 追踪当前步骤
  if (tocObserver) tocObserver.disconnect();
  var items = tocList.querySelectorAll('.toc-item');
  tocObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        var idx = parseInt(entry.target.getAttribute('data-step-idx'), 10);
        for (var j = 0; j < items.length; j++) {
          items[j].classList.toggle('active', j === idx);
        }
      }
    });
  }, { rootMargin: '-30% 0px -50% 0px', threshold: 0.1 });

  setTimeout(function() {
    var cards = document.querySelectorAll('.step-card');
    cards.forEach(function(card, ci) {
      card.setAttribute('data-step-idx', ci);
      tocObserver.observe(card);
    });
  }, 100);
}

/* ====== DESIGN PREVIEW + LIGHTBOX ====== */
function initDesignPreview() {
  var thumb = $('design-thumb');
  var thumbImg = $('design-thumb-img');
  var overlay = $('lightbox-overlay');
  var lbImg = $('lightbox-img');
  var lbClose = $('lightbox-close');

  // 使用上传页的预览图作为来源
  if (uploadedImageUrl) {
    thumbImg.src = uploadedImageUrl;
    lbImg.src = uploadedImageUrl;
    thumb.style.display = 'block';
  }

  thumb.onclick = function() {
    overlay.classList.add('visible');
  };

  lbClose.onclick = function() {
    overlay.classList.remove('visible');
  };

  overlay.onclick = function(e) {
    if (e.target === overlay) {
      overlay.classList.remove('visible');
    }
  };

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && overlay.classList.contains('visible')) {
      overlay.classList.remove('visible');
    }
  });
}

/* ====== RENDER ====== */
function renderTutorial() {
  var d = tutorialData;
  if (!d) { showError('没有教程数据'); showScreen('upload'); return; }

  // difficulty: 强制转成 0-5 之间的安全整数
  var dif = parseInt(d.difficulty, 10);
  if (isNaN(dif) || dif < 0) dif = 3;
  if (dif > 5) dif = 5;

  // topbar
  $('design-name').textContent = d.designName || '立裁教程';
  var difDotsHtml = '';
  for (var i = 1; i <= 5; i++) {
    difDotsHtml += '<div class="dot' + (i <= dif ? ' filled' : '') + '"></div>';
  }
  difDotsHtml += '<span class="label">' + (DIF_LABELS[dif] || '') + '</span>';
  $('difficulty-dots').innerHTML = difDotsHtml;

  // right panel
  var rp = $('right-panel');
  var html = '';

  // overview - 用 safeRepeat 确保绝不报错
  var steps = Array.isArray(d.steps) ? d.steps : [];
  html += '<div class="overview-card">';
  html += '<h3>设计总览</h3>';
  html += '<p class="analysis">' + (d.designAnalysis || '') + '</p>';
  html += '<div class="overview-meta">';
  html += '<div class="meta-item"><div class="meta-label">难度</div><div class="meta-value">' + safeRepeat('●', dif) + safeRepeat('○', 5 - dif) + ' ' + (DIF_LABELS[dif] || '') + '</div></div>';
  html += '<div class="meta-item"><div class="meta-label">预计时间</div><div class="meta-value">' + (d.estimatedTime || '未知') + '</div></div>';
  html += '<div class="meta-item"><div class="meta-label">步骤数</div><div class="meta-value">' + steps.length + ' 步</div></div>';
  html += '</div></div>';

  // materials
  var mats = Array.isArray(d.materials) ? d.materials : [];
  var matsHtml = '';
  for (var mi = 0; mi < mats.length; mi++) {
    var m = mats[mi];
    matsHtml += '<div class="list-item"><div class="name">' + (m.item || '') + '</div><div class="spec">' + (m.spec || '') + '</div><div class="qty">用量：' + (m.qty || '适量') + '</div></div>';
  }
  if (!matsHtml) matsHtml = '<p style="color:#999;font-size:13px">暂无材料信息</p>';

  // tools
  var tools = Array.isArray(d.tools) ? d.tools : [];
  var toolsHtml = '';
  for (var ti = 0; ti < tools.length; ti++) {
    var t = tools[ti];
    toolsHtml += '<div class="list-item"><div class="name">' + (t.name || '') + '</div><div class="spec">' + (t.purpose || '') + '</div></div>';
  }
  if (!toolsHtml) toolsHtml = '<p style="color:#999;font-size:13px">暂无工具信息</p>';

  html += '<div class="list-row" style="animation:fadeUp 0.5s ease 0.1s both">';
  html += '<div class="list-card"><h4>\uD83E\uDDF5 材料清单</h4>' + matsHtml + '</div>';
  html += '<div class="list-card"><h4>\uD83D\uDD27 工具清单</h4>' + toolsHtml + '</div>';
  html += '</div>';

  // divider
  html += '<div class="section-divider"><div class="line"></div><span class="title">操作步骤</span><div class="line"></div></div>';

  // steps
  for (var si = 0; si < steps.length; si++) {
    var s = steps[si];
    var icon = ICONS[s.icon] || '\uD83D\uDCCC';
    var areaLabel = AREA_LABELS[s.area] || s.area || '';

    html += '<div class="step-card" style="animation:fadeUp 0.5s ease ' + (si * 0.06) + 's both">';
    html += '<div class="step-header">';
    html += '<div class="step-num">' + (si + 1) + '</div>';
    html += '<span class="step-icon">' + icon + '</span>';
    html += '<div class="step-title-wrap"><h3>' + (s.title || '') + '</h3>';
    if (s.technique) html += '<span class="technique">技法：' + s.technique + '</span>';
    html += '</div>';
    html += '<span class="area-tag">' + areaLabel + '</span>';
    html += '</div>';

    // flex 布局：左文字 + 右人台 SVG
    html += '<div class="step-body">';
    html += '<div class="step-text">';
    html += '<p class="step-desc">' + (s.desc || '') + '</p>';

    if (s.tips) {
      html += '<div class="tips-box"><div class="tips-label">\uD83D\uDCA1 操作贴士</div><p>' + s.tips + '</p></div>';
    }

    var troubles = Array.isArray(s.troubles) ? s.troubles : [];
    if (troubles.length > 0) {
      html += '<div class="trouble-section">';
      html += '<button class="trouble-toggle" onclick="this.querySelector(\'.arrow\').classList.toggle(\'open\');this.nextElementSibling.classList.toggle(\'open\')">';
      html += '<span class="arrow">\u25B8</span> \u26A0\uFE0F 常见问题排解 (' + troubles.length + ')';
      html += '</button><div class="trouble-content">';
      for (var tbi = 0; tbi < troubles.length; tbi++) {
        html += '<div class="trouble-item"><p class="q">\u2753 ' + (troubles[tbi].q || '') + '</p><p class="a">\u2192 ' + (troubles[tbi].a || '') + '</p></div>';
      }
      html += '</div></div>';
    }
    html += '</div>'; // end .step-text

    // 人台 SVG
    html += '<div class="step-mannequin">' + buildMannequinSVG(s.area || 'full', si + 1) + '</div>';
    html += '</div>'; // end .step-body

    html += '<div class="step-progress">步骤 ' + (si + 1) + ' / ' + steps.length + '</div>';
    html += '</div>';
  }

  // completion
  html += '<div class="completion"><div class="emoji">\uD83C\uDF89</div><h3>教程完成！</h3>';
  html += '<p>按照以上步骤操作，你就能在人台上实现这个设计。记得边做边拍照记录。</p>';
  html += '<button class="btn btn-primary" onclick="document.getElementById(\'btn-back\').click()">分析新的设计 \u2192</button>';
  html += '</div>';

  rp.innerHTML = html;

  // 初始化三大功能
  initStepTOC();
  initDesignPreview();
}
</script>
</body>
</html>
